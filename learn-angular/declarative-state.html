<!DOCTYPE html>
<!--####################################################################
	THIS IS A GENERATED FILE — ANY CHANGES MADE WILL BE OVERWRITTEN

	INSTEAD CHANGE:
	source: src/angular/11-declarative-state/declarative-state.md
	@page learn-angular/declarative-state
######################################################################## -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="UMCgjrWAjJW_tHmYo6AerdZvVdmh8QHdY9Ywb59tpHw" />
  <meta name="description" content="Modify Restaurants component to derive state via RxJS streams 
">
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-P9MQVJS');</script>
  <!-- End Google Tag Manager -->

  <title>Bitovi Academy - Optional: Declarative State</title>
  
  <link rel="stylesheet" type="text/css" href="../static/bundles/bit-docs-site/static.css">
  
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P9MQVJS"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  
  <div class="header">
    <div class="logo">
      <a href="https://www.bitovi.com/">Bitovi</a>
    </div>
    <ul>
      <li><a href="https://www.bitovi.com/services">Services</a></li>
      <li><a href="https://www.bitovi.com/client-work">Client Work</a></li>
      <li><a href="https://www.bitovi.com/about">Our Team</a></li>
      <li><a href="https://www.bitovi.com/open-source">Open Source</a></li>
      <li><a href="https://www.bitovi.com/blog">Blog</a></li>
      <li><a href=".." class="active">Academy</a></li>
     </ul>
     <a class="contact-popup hs-button brand button-smallest" href="https://www.bitovi.com/contact">Contact Us</a>
  </div>

  <div class="content">
	
		<div class="sidebar-left">
  
    
	<ul>
		
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-advanced-javascript.html"
							title="This course covers all the hard but important stuff you should know when learning JavaScript.">
							Advanced JavaScript
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-dom-jquery.html"
							title="Learn jQuery and the DOM APIs by building your own version of jQuery and using it to make a basic tabs widget. We strongly suggest finishing learn-advanced-javascript prior to starting this course.">
							DOM and jQuery
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-to-debug-javascript.html"
							title="This course covers the basics of JavaScript debugging.">
							Debug JavaScript
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-typescript.html"
							title="This course covers the basic essentials of TypeScript. At the end, you should be ready to develop projects in TypeScript.">
							Learn TypeScript
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-react-native.html"
							title="Learn React Native by building the feature-rich Place My Order application in this beginner React Native guide. This hands-on course will introduce you to fundamental React Native concepts! By the end of this course, you will have a strong understanding of JSX, function components, styling, state management, Hooks, data fetching, routing, and testing.">
							Learn React Native
						</a>
						
					</li>
				
			
		
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-web-components.html"
							title="">
							Learn Web Components
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-agile-program-management-with-jira.html"
							title="Learn how to build, maintain, and report on accurate multi-team plans with Jira.">
							Agile Program Management With Jira
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-rxjs.html"
							title="Learn RxJS by creating a validating credit card form.">
							Learn RxJS
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../training.html"
							title="Learn how to prepare and give a training.">
							Giving a Training
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-technology-consulting.html"
							title="Learn how to move beyond writing code to be an excellent technology consultant!">
							Learn Technology Consulting
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-react.html"
							title="Learn React by building the feature-rich Place My Order application in this beginner React guide. This hands-on course will introduce you to fundamental React concepts! By the end of this course, you will have a strong understanding of JSX, function components, styling, state management, Hooks, data fetching, routing, and testing.">
							Learn React
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-ngrx.html"
							title="Learn how to manage state in an Angular application using NgRx.">
							Learn NgRx
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-graphql.html"
							title="Build a backend application for property rentals using Node JS, GraphQL and Apollo Server.         Learn about using ORMs like Mongoose and Prisma with a NoSQL Mongo database!
Write testcases testing created endpoints.">
							Learn Graphql
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-docker.html"
							title="Build and containerize a Node.js app then orchestrate multiple containers with docker-compose in this Docker guide.">
							Learn Docker
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../learn-canjs.html"
							title="This tutorial walks through building TodoMVC with StealJS. It includes KeyNote presentations
covering CanJS core libraries.">
							Learn CanJS
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						parent
           						expanded">
						<a class="page"
							href="../learn-angular.html"
							title="Learn how to build a moderately complex application with Angular.">
							Learn Angular
						</a>
						
							
	<ul>
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="why-angular.html"
							title="Discover why Angular is a great choice for modern web application development.">
							Why Angular?
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="building-our-first-app.html"
							title="Learn how to generate an Angular 17 application with its command line interface (CLI).">
							Generate an App
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="creating-components.html"
							title="Learn how to create basic components in Angular and iterate through data using an Angular for loop.">
							Creating Components
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="creating-pipes.html"
							title="Learn how to create a custom pipe in Angular that returns a modified version of a string.">
							Creating Pipes
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="adding-routing.html"
							title="Learn how to add basic routing to components in an Angular application.">
							Adding Routing
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="creating-navigation.html"
							title="Learn how to create dynamic links with Angular that navigate to different parts of an application.">
							Creating Navigation
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="restaurant-service.html"
							title="Learn how to write an Angular service that gets data from the server.">
							Fetching Data with Services
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="pull-restaurant-data-into-view.html"
							title="Learn how to render API data into HTML with a view.">
							Rendering Data in Components
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="state-city-options.html"
							title="Learn how to create a Reactive Form with Angular. We will create a Reactive Form in the Restaurant component with city and state dropdown inputs.">
							Reactive Forms Data Binding
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="form-value-changes.html"
							title="Learn how to listen to form value changes with Angular.">
							Listening to Form Changes
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="updating-service-params.html"
							title="Learn how to make a service take multiple parameters.">
							Multi-parameter Services
						</a>
						
					</li>
				
			
		
			
				
					<li class="current
           						parent
           						expanded">
						<a class="page"
							href="declarative-state.html"
							title="Modify Restaurants component to derive state via RxJS streams">
							Optional: Declarative State
						</a>
						
							

						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="writing-unit-tests.html"
							title="Write a unit test for a service in Angular.">
							Writing Unit Tests
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="nested-routes.html"
							title="Creating nested restaurant routes.">
							Creating Nested Routes
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="building-order-form.html"
							title="Building the Order Form">
							Binding Component Data
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="creating-directive.html"
							title="Learn how to create Directives in Angular that can change the appearance or behavior of DOM Elements.">
							Creating Directives
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="order-service.html"
							title="Writing the Order Service">
							Order Service
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="order-history-component.html"
							title="Writing the Order History Component">
							Order History Component
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="item-total-pipe.html"
							title="Write an Item Total Pipe to help manage item total calculation across our application.">
							Item Total Pipe
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="real-time-connection.html"
							title="Updating Order History View with Real Time Connection">
							Real Time Connections
						</a>
						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="deploy-app.html"
							title="Deploying App">
							Deploy App
						</a>
						
					</li>
				
			
		
	</ul>


						
					</li>
				
			
		
			
				
					<li class="
           						
           						">
						<a class="page"
							href="../advanced-typescript.html"
							title="This is the second course in the TypeScript series. By the end, you will be comfortable with any types you come across and possess the knowledge to create your own advanced types. The only prerequisite is the first course in the TypeScript series found here.">
							Advanced TypeScript
						</a>
						
					</li>
				
			
		
	</ul>


  
  <p class="border">
      <a href="..#courses">View More Courses</a>
      <a class='bit-academy-fullscreen' title='fullscreen' href="javascript://">[ ]</a>
  </p>
</div>

	
	<article class="main">
    <div class="main-content">
  		
  			<section class="title">
	<h1>Optional: Declarative State <code>page</code></h1>
</section>

  		

  		
  			
  				<section class="description">
    <p>Modify Restaurants component to derive state via RxJS streams</p>

</section>

  			
  		

  		
  			
  				
  			
  			
  				<section class="body">
    <h2>Overview</h2>
<p>In this part, we will:</p>
<ul>
<li>Learn the differences between imperative and declarative state</li>
<li>Learn some essential RxJS operators and static functions</li>
<li>Update the restaurant component so states, cities &amp; restaurants are RxJS streams</li>
<li>Add additional streams to avoid the use of imperative logic</li>
</ul>
<p><strong>Note:</strong> You should complete <a href="../learn-rxjs.html">Bitovi Academy’s RxJS training</a> before attempting
the following exercise. Although even if you haven’t, read on if you’re interested why you might want to use declarative
state.</p>
<h2>Imperative vs Declarative state</h2>
<p>To understand the difference between imperative and declarative styles of programming we first need to review the
concept of state. State is essentially the &quot;remembered information&quot; of a program, <em>i.e</em> the variables used as part of
the program. Imperative &amp; declarative styles differ in how the program specifies the state.</p>
<p>The code we’ve written thus far has been in an imperative style, <em>i.e</em> when events occur, code runs that changes
the state of the program accordingly. The state is determined by actions throughout the program that directly modify the
state. This model of programming is very familiar, although it can become quite difficult to trace the modifications to
the state as an application grows in complexity.</p>
<pre><code class="language-html">&lt;script type=&quot;module&quot;&gt;
  let x = '';
  console.info('x: ' + x);
  setInterval(() =&gt; {
    x = x + 'A';
    console.info('x: ' + x);
  }, 1000);

  // logs:
  // x:
  // (... 1 second passes)
  // x: A
  // (... 1 second passes)
  // x: AA
  // (... and so on)
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<p>In contrast, a declarative style of programming expresses state by specifying how values should be generated. i.e state
specifies which events should be reacted to and what actions will occur to produce those state values. This subtle
distinction has some very useful implications.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { timer } = rxjs;
  const { map } = rxjs.operators;

  // act on a number starting at 0 and incrementing every 1000ms afterwards
  const x$ = timer(0, 1000).pipe(
    // create a string of As the length of the incrementing number
    map((length) =&gt; Array(length).fill('A').join(''))
  );
  x$.subscribe((value) =&gt; console.info('x: ' + value));

  // logs:
  // x:
  // (... 1 second passes)
  // x: A
  // (... 1 second passes)
  // x: AA
  // (... an so on)
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<p>Declarative state, once you’re familiar with it, is typically easier to follow. Understanding how a piece of the program’s
state is generated only requires reading the state’s definition. The actions that are part of the definition explain
everything about how the state is created. In imperative code you’d need to read the code anywhere the state is modified.</p>
<p>Code using declarative state is often shorter than imperative code since you’re not needing to write as much flow control logic.</p>
<p>Declarative state can be less error prone. It’s typically more specific about how state is generated relative to
imperative code, which may modify state under conditions which may at first seem correct, but end up having unintended
consequences.</p>
<p>An additional benefit of Angular + RxJS is that declarative state can be used directly in the template with the async pipe, removing the need
for most subscriptions in our component. Avoiding subscriptions eliminates the need to manage them in <code>onDestroy</code>.</p>
<h2>Essential RxJS Operators &amp; Functions</h2>
<p>RxJS operators are the actions that run to modify values in a stream. There are dozens of operators that do things
like transform individual values, filter values, combine streams, and much more. We’ll just be touching on a small
selection of operators.</p>
<p>We’ll also demonstrate important RxJS static functions used to create and combine streams.</p>
<h3>Creating A Stream</h3>
<p>The <a href="https://rxjs.dev/api/index/function/of"><code>of</code></a> function simply creates an observable that emits
the values passed to <a href="https://rxjs.dev/api/index/function/of"><code>of</code></a>. This is often used when creating
demo streams or composing streams.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of } = rxjs;

  of(1, 2, 3, 4).subscribe((v) =&gt; {
    console.info(v);
  });

  // logs:
  // 1
  // 2
  // 3
  // 4
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<p>In the solution of this exercise we’ll use <a href="https://rxjs.dev/api/index/function/of"><code>of</code></a> to return a
stream during <a href="https://rxjs.dev/api/operators/mergeMap"><code>mergeMap</code></a>. Look at the
<a href="https://rxjs.dev/api/operators/mergeMap"><code>mergeMap</code></a> example below to see that in action.</p>
<h3>Combining Streams</h3>
<p><a href="https://rxjs.dev/api/index/function/combineLatest"><code>combineLatest</code></a> returns a
stream that emits arrays containing the most recent values of each stream. One caveat is that
<a href="https://rxjs.dev/api/index/function/combineLatest"><code>combineLatest</code></a> will only start emitting arrays
when all input streams have emitted a value.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of, combineLatest, zip, interval } = rxjs;
  const { map } = rxjs.operators;

  // emits the values every 750ms in order
  const selectedHatStream$ = zip(
    of('Bowler', 'Top', 'Baseball'),
    interval(750)
  ).pipe(map(([value, num]) =&gt; value));

  // emits the values every 2000ms in order
  const selectedJacketStream$ = zip(
    of('Trenchcoat', 'Tuxedo', 'Bomber'),
    interval(2000)
  ).pipe(map(([value, num]) =&gt; value));

  combineLatest(selectedHatStream$, selectedJacketStream$).subscribe(
    ([hat, jacket]) =&gt; {
      console.info(`selected outfit: ${hat} hat &amp; ${jacket} jacket`);
    }
  );

  // logs:
  // (... 2 seconds pass)
  // selected outfit: Top hat &amp; Trenchcoat jacket
  // (... 250 milliseconds pass)
  // selected outfit: Baseball hat &amp; Trenchcoat jacket
  // (... 1.75 seconds pass)
  // selected outfit: Baseball hat &amp; Tuxedo jacket
  // (... 2 seconds pass)
  // selected outfit: Baseball hat &amp; Bomber jacket
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<h3>Initializing A Stream</h3>
<p>A common situation is working with streams that only produce a value after an event, for example when an HTTP request
completes or when a value changes in a form control. When using a stream like this in your components, you’ll likely
want to have an initial &quot;base state&quot; that your view can use during the initial render. In RxJS this is handled by the
<a href="https://rxjs.dev/api/operators/startWith"><code>startWith</code></a> operator, which emits a value when the
stream is first subscribed to.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of } = rxjs;
  const { delay, startWith } = rxjs.operators;

  // emits an array of 3 values after a 1000ms delay, like a request returning results
  const pseudoRequest$ = of([1, 2, 3]).pipe(delay(1000));
  // immediately emits an empty array followed 1 second later by the array from pseudoRequest
  const baseCaseAdded$ = pseudoRequest$.pipe(startWith([]));

  baseCaseAdded$.subscribe((arr) =&gt; {
    console.info('Contents: ' + JSON.stringify(arr));
  });

  // logs:
  // Contents: []
  // (... 1 second passes)
  // Contents: [1,2,3]
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<h3>Transforming The Values Of A Stream</h3>
<p>When values are emitted from a stream it’s common to transform them in some way before they’re used by your application.
One operator used for this is the <a href="https://rxjs.dev/api/operators/map"><code>map</code></a> operator, which
takes an emitted value and returns a modified value that will be passed to the subsequent operators in the stream.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of } = rxjs;
  const { map } = rxjs.operators;

  of(1, 2, 3)
    .pipe(map((v) =&gt; v * 2))
    .subscribe((v) =&gt; {
      console.info('Value: ' + v);
    });

  // logs:
  // Value: 2
  // Value: 4
  // Value: 6
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<h3>Emitting Values From Another Stream</h3>
<p>When using a stream you may want to emit values from another stream as part of the original stream. RxJS offers a
variety of ways to do this, but the one we’ll demonstrate is the
<a href="https://rxjs.dev/api/operators/mergeMap"><code>mergeMap</code></a> operator. Like the map operator it takes an
emitted value from a stream, but instead of returning a modified value it returns another stream whose emitted values
will be passed to the subsequent operators.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
    const { of, interval, zip } = rxjs;
    const { map, mergeMap, delay } = rxjs.operators;

    // returns a stream that emits the price of a given menu item after a 500ms delay. this is how a request might operate
    function pseudoPriceRequest(menuItem) {
        if (menuItem === 'Truffle Noodles') {
            return of(14.99).pipe(delay(500))
        } else if (menuItem === 'Charred Octopus') {
            return of(25.99).pipe(delay(500))
        }
    }

    // emits the values every 2 seconds in order
    const pseudoFormValueStream = zip(of('', 'Truffle Noodles', 'Charred Octopus', ''), interval(2000)).pipe(map(([value, num]) =&gt; value));

    // stream that makes a &quot;request&quot; if provided a menu item name or returns &quot;No Item Selected&quot;
    const pseudoPriceStream = pseudoFormValueStream.pipe(mergeMap((selectedItem) =&gt; {
        if (selectedItem) {
            return pseudoPriceRequest(selectedItem).pipe(map(price =&gt; '$' + price));
        } else {
            return of('No Item Selected');
        }
    }));

    pseudoPriceStream.subscribe((price) =&gt; {
        console.info('Price Of Selected Item: ' + price);
    })

    // logs:
    // (... 2 seconds pass)
    // Price Of Selected Item: No Item Selected
    // (... 2.5 seconds pass)
    // Price Of Selected Item: $14.99
    // (... 2 seconds pass)
    // Price Of Selected Item: $25.99
    // (... 2 seconds pass)
    // Price Of Selected Item: No Item Selected
&lt;/script&gt;
</code></pre>
<div class='codepen'></div>
<h3>Combining Previous And Current Emissions Of A Stream</h3>
<p>If you need to compare the current (latest) emitted value with the previous value of a stream, you can use the <a href="https://rxjs.dev/api/operators/pairwise"><code>pairwise</code></a> operator. Once there are at least 2 emitted values, it starts emitting an array: <code>[previous, current]</code>.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of, interval, zip } = rxjs;
  const { map, pairwise } = rxjs.operators;

  // emits the values every 2 seconds in order
  const menuItems$ = zip(
    of('Steamed Mussels', 'Truffle Noodles', 'Charred Octopus', 'Onion fries'),
    interval(2000)
  ).pipe(map(([value, num]) =&gt; value));

  menuItems$.pipe(pairwise()).subscribe(([previous, current]) =&gt; {
    console.info('Previous: ' + previous, 'Current: ' + current);
  });

  // logs:
  // (... 2 seconds pass), &quot;Steamed Mussels&quot; is emitted by menuItems$
  // (... 2 seconds pass), &quot;Truffle Noodles&quot; is emitted by menuItems$
  // &quot;Previous: Steamed Mussels&quot; &quot;Current: Truffle Noodles&quot;
  // (... 2 seconds pass), &quot;Charred Octopus&quot; is emitted by menuItems$
  // &quot;Previous: Truffle Noodles&quot; &quot;Current: Charred Octopus&quot;
  // (... 2 seconds pass), &quot;Onion fries&quot; is emitted by menuItems$
  // &quot;Previous: Charred Octopus&quot; &quot;Current: Onion fries&quot;
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<h3>Handling Multiple Subscribers To A Stream</h3>
<p>An advanced topic when working with streams is how streams behave when they have multiple subscribers. To understand
this you first need an understanding of &quot;cold&quot; vs &quot;hot&quot; observables.</p>
<p>A &quot;cold&quot; observable is one that creates a new producer of events whenever they receive a new subscriber. An example is
observables returned from the Angular <a href="https://angular.io/api/common/http/HttpClient"><code>HttpClient</code></a>. Whenever there’s
a new subscriber to that observable a new request is made.</p>
<p>A &quot;hot&quot; observable is one that doesn’t create a new producer for every subscriber. Instead it shares a single producer
among all the subscribers. An example of this could be an observable that listens for messages on an existing
WebSocket connection. Whenever there’s a new subscriber to the observable, a new listener is added, but a new connection
isn’t opened, the connection is being shared between the subscribers.</p>
<p>This distinction is clearly important, you wouldn’t want to make separate requests for states in every place that
you reference the states observable in the view. You need some way to make cold observables hot. To satisfy that
requirement RxJS contains a variety of ways to share the stream between subscribers. This is a particularly complex
topic so we’ll only be reviewing a single way, the
<a href="https://rxjs.dev/api/operators/shareReplay"><code>shareReplay</code></a> operator.</p>
<p>The <a href="https://rxjs.dev/api/operators/shareReplay"><code>shareReplay</code></a> operator essentially works by
making the preceding portion of the stream hot. Once the stream is subscribed to,
<a href="https://rxjs.dev/api/operators/shareReplay"><code>shareReplay</code></a> will share the results produced,
preventing multiple instances of the stream from running. That’s the &quot;sharing&quot; functionality of
<a href="https://rxjs.dev/api/operators/shareReplay"><code>shareReplay</code></a>, but it also performs the other
important function of &quot;replaying&quot;.</p>
<p>In our template we have code that looks like:</p>
<pre><code class="language-html">&lt;ng-container *ngIf=&quot;!states.isPending&quot;&gt;
  &lt;option value=&quot;&quot;&gt;Choose a state&lt;/option&gt;
  &lt;option *ngFor=&quot;let state of states.value&quot; value=&quot;{{state?.short}}&quot;&gt;
    {{state?.name}}
  &lt;/option&gt;
&lt;/ng-container&gt;
</code></pre>
<p>This code poses a problem since the <code>ngFor</code> doesn’t get rendered until after <code>states.isPending === false</code>. If states was a
stream, <code>isPending</code> would only be false after the response from the HTTP request was produced. After that <code>ngFor</code> would
be rendered, subscribe to <code>states</code>, and do... nothing. This is because the <code>ngFor</code> subscribed late, after the data it
needed was already produced by the stream. <code>ngFor</code> missed it’s chance to get that data.</p>
<p>What we need is for <code>ngFor</code> to get replayed the last value emitted by the stream once it subscribes. <code>shareReplay(1)</code>
will buffer the last emission of the preceding stream, and replay it for any late subscribers. Now when <code>ngFor</code> gets
rendered and subscribes, it will receive the successful HTTP request and render the list of state options.</p>
<pre><code class="language-html">&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;module&quot;&gt;
  const { of, interval, zip } = rxjs;
  const { map, shareReplay } = rxjs.operators;

  // emits the values every 2 seconds in order
  const pseudoFormValueStream$ = zip(
    of('Truffle Noodles', 'Charred Octopus', 'Gunthorp Chicken'),
    interval(2000)
  ).pipe(map(([value, num]) =&gt; value));

  // prevents multiple instances of pseudoFormValueStream$ from being created for each subscriber
  const sharedFormValues$ = pseudoFormValueStream$.pipe(shareReplay(1));

  // subscriber 1, will subscribe to stream, starting values to be emitted
  sharedFormValues$.subscribe((menuItem) =&gt; {
    console.info('s1: ' + menuItem);
  });

  // subscriber 2, subscribes late, but still emits 'Truffle Noodles' because the stream replays it.
  // afterwards works like subscriber 1, logging at the same time since they’re both listening to same hot observable.
  setTimeout(() =&gt; {
    sharedFormValues$.subscribe((menuItem) =&gt; {
      console.info('s2: ' + menuItem);
    });
  }, 2500);

  // subscriber 3, subscribes after the stream completes, but still emits 'Gunthorp Chicken' because the stream replays it.
  setTimeout(() =&gt; {
    sharedFormValues$.subscribe((menuItem) =&gt; {
      console.info('s3: ' + menuItem);
    });
  }, 6500);

  // logs:
  // (... 2 seconds pass)
  // s1: Truffle Noodles
  // (... .5 seconds pass)
  // s2: Truffle Noodles
  // (... 1.5 seconds pass)
  // s1: Charred Octopus
  // s2: Charred Octopus
  // (... 2 seconds pass)
  // s1: Gunthorp Chicken
  // s2: Gunthorp Chicken
  // (... .5 seconds pass)
  // s3: Gunthorp Chicken
&lt;/script&gt;

</code></pre>
<div class='codepen'></div>
<p>To go more in depth about this topic check out these articles:</p>
<ul>
<li><a href="https://medium.com/@benlesh/hot-vs-cold-observables-f8094ed53339">Hot vs Cold Observables</a></li>
<li><a href="https://itnext.io/the-magic-of-rxjs-sharing-operators-and-their-differences-3a03d699d255">The Magic Of RxJS Sharing Operators</a></li>
</ul>
<h2>Problem</h2>
<p>Convert the imperatively managed state in the restaurant component to declarative state.</p>
<h2>Technical requirements</h2>
<p>When you’re finished the component members <code>states$</code>, <code>cities$</code> &amp; <code>restaurants$</code> will be of the types <code>Observable&lt;Data&lt;State&gt;&gt;</code>,
<code>Observable&lt;Data&lt;City&gt;&gt;</code> and <code>Observable&lt;Data&lt;Restaurant&gt;&gt;</code> respectively. Each will be defined as a set of RxJS
operators that either produce values from a response emitted by a service layer request, or produce values from changes
in a form control (which in turn may make a request).</p>
<p>You’ll define <code>selectedState$</code> and <code>selectedCity$</code> members to be of Type <code>Observable&lt;string&gt;</code> to represent current form control values. To access form values as streams you’ll use the <code>valueChanges</code> observable available in each <code>FormControl</code>.</p>
<p>You’ll also add new single-responsibility streams:</p>
<ul>
<li><code>enableStateSelect$</code> which enables the state select control once state values are available</li>
<li><code>toggleCitySelect$</code> which enables/disables the city select control if loading is ongoing or no values are available</li>
<li><code>clearCityWhenStateChanges$</code> which clears the city select control value if the state select control has been changed</li>
</ul>
<h2>How to verify your solution is correct</h2>
<p>✏️ Update the spec file <strong>src/app/restaurant/restaurant.component.spec.ts</strong> to be:</p>
<pre><code class="language-ts">import {
  ComponentFixture,
  fakeAsync,
  TestBed,
  tick,
} from '@angular/core/testing';
import { ReactiveFormsModule } from '@angular/forms';
import { RouterTestingModule } from '@angular/router/testing';
import { delay, of } from 'rxjs';
import { ImageUrlPipe } from '../image-url.pipe';
import { Restaurant } from './restaurant';
import { Data, RestaurantComponent } from './restaurant.component';
import { City, RestaurantService, State } from './restaurant.service';

const restaurantAPIResponse = {
  data: [
    {
      name: 'Poutine Palace',
      slug: 'poutine-palace',
      images: {
        thumbnail: 'node_modules/place-my-order-assets/images/4-thumbnail.jpg',
        owner: 'node_modules/place-my-order-assets/images/3-owner.jpg',
        banner: 'node_modules/place-my-order-assets/images/2-banner.jpg',
      },
      menu: {
        lunch: [
          {
            name: 'Crab Pancakes with Sorrel Syrup',
            price: 35.99,
          },
          {
            name: 'Steamed Mussels',
            price: 21.99,
          },
          {
            name: 'Spinach Fennel Watercress Ravioli',
            price: 35.99,
          },
        ],
        dinner: [
          {
            name: 'Gunthorp Chicken',
            price: 21.99,
          },
          {
            name: 'Herring in Lavender Dill Reduction',
            price: 45.99,
          },
          {
            name: 'Chicken with Tomato Carrot Chutney Sauce',
            price: 45.99,
          },
        ],
      },
      address: {
        street: '230 W Kinzie Street',
        city: 'Green Bay',
        state: 'WI',
        zip: '53205',
      },
      _id: '3ZOZyTY1LH26LnVw',
    },
    {
      name: 'Cheese Curd City',
      slug: 'cheese-curd-city',
      images: {
        thumbnail: 'node_modules/place-my-order-assets/images/2-thumbnail.jpg',
        owner: 'node_modules/place-my-order-assets/images/3-owner.jpg',
        banner: 'node_modules/place-my-order-assets/images/2-banner.jpg',
      },
      menu: {
        lunch: [
          {
            name: 'Ricotta Gnocchi',
            price: 15.99,
          },
          {
            name: 'Gunthorp Chicken',
            price: 21.99,
          },
          {
            name: 'Garlic Fries',
            price: 15.99,
          },
        ],
        dinner: [
          {
            name: 'Herring in Lavender Dill Reduction',
            price: 45.99,
          },
          {
            name: 'Truffle Noodles',
            price: 14.99,
          },
          {
            name: 'Charred Octopus',
            price: 25.99,
          },
        ],
      },
      address: {
        street: '2451 W Washburne Ave',
        city: 'Green Bay',
        state: 'WI',
        zip: '53295',
      },
      _id: 'Ar0qBJHxM3ecOhcr',
    },
  ],
};

class MockRestaurantService {
  getRestaurants(state: string, city: string) {
    return of(restaurantAPIResponse);
  }

  getStates() {
    return of({
      data: [
        { short: 'MO', name: 'Missouri' },
        { short: 'CA  ', name: 'California' },
        { short: 'MI', name: 'Michigan' },
      ],
    });
  }

  getCities(state: string) {
    return of({
      data: [
        { name: 'Sacramento', state: 'CA' },
        { name: 'Oakland', state: 'CA' },
      ],
    });
  }
}

describe('RestaurantComponent', () =&gt; {
  let fixture: ComponentFixture&lt;RestaurantComponent&gt;;
  let service: RestaurantService;

  beforeEach(async () =&gt; {
    await TestBed.configureTestingModule({
      imports: [RouterTestingModule, ReactiveFormsModule],
      declarations: [RestaurantComponent, ImageUrlPipe],
      providers: [
        { provide: RestaurantService, useClass: MockRestaurantService },
      ],
    }).compileComponents();

    service = TestBed.inject(RestaurantService);
    fixture = TestBed.createComponent(RestaurantComponent);
  });

  it('should create', () =&gt; {
    const component: RestaurantComponent = fixture.componentInstance;
    expect(component).toBeTruthy();
  });

  it('should render title in a h2 tag', () =&gt; {
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('h2')?.textContent).toContain('Restaurants');
  });

  it('should not show any restaurants markup if no restaurants', () =&gt; {
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('.restaurant')).toBe(null);
  });

  it('should have two .restaurant divs', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick(501);
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.componentInstance.form.get('city')?.patchValue('Sacramento');
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const restaurantDivs = compiled.getElementsByClassName('restaurant');
    const hoursDivs = compiled.getElementsByClassName('hours-price');
    expect(restaurantDivs.length).toEqual(2);
    expect(hoursDivs.length).toEqual(2);
  }));

  it('should display restaurant information', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick(501);
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.componentInstance.form.get('city')?.patchValue('Sacramento');
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    expect(compiled.querySelector('.restaurant h3')?.textContent).toContain(
      'Poutine Palace'
    );
  }));

  it('should set restaurants value to restaurants response data and set isPending to false when state and city form values are selected', fakeAsync((): void =&gt; {
    const fixture = TestBed.createComponent(RestaurantComponent);
    fixture.detectChanges();
    tick();

    let restaurantOutput!: Data&lt;Restaurant&gt;;

    fixture.componentInstance.restaurants$.subscribe(
      (restaurants) =&gt; (restaurantOutput = restaurants)
    );
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.componentInstance.form.get('city')?.patchValue('Sacramento');
    fixture.detectChanges();
    const expectedRestaurants = {
      value: [
        {
          name: 'Poutine Palace',
          slug: 'poutine-palace',
          images: {
            thumbnail:
              'node_modules/place-my-order-assets/images/4-thumbnail.jpg',
            owner: 'node_modules/place-my-order-assets/images/3-owner.jpg',
            banner: 'node_modules/place-my-order-assets/images/2-banner.jpg',
          },
          menu: {
            lunch: [
              {
                name: 'Crab Pancakes with Sorrel Syrup',
                price: 35.99,
              },
              {
                name: 'Steamed Mussels',
                price: 21.99,
              },
              {
                name: 'Spinach Fennel Watercress Ravioli',
                price: 35.99,
              },
            ],
            dinner: [
              {
                name: 'Gunthorp Chicken',
                price: 21.99,
              },
              {
                name: 'Herring in Lavender Dill Reduction',
                price: 45.99,
              },
              {
                name: 'Chicken with Tomato Carrot Chutney Sauce',
                price: 45.99,
              },
            ],
          },
          address: {
            street: '230 W Kinzie Street',
            city: 'Green Bay',
            state: 'WI',
            zip: '53205',
          },
          _id: '3ZOZyTY1LH26LnVw',
        },
        {
          name: 'Cheese Curd City',
          slug: 'cheese-curd-city',
          images: {
            thumbnail:
              'node_modules/place-my-order-assets/images/2-thumbnail.jpg',
            owner: 'node_modules/place-my-order-assets/images/3-owner.jpg',
            banner: 'node_modules/place-my-order-assets/images/2-banner.jpg',
          },
          menu: {
            lunch: [
              {
                name: 'Ricotta Gnocchi',
                price: 15.99,
              },
              {
                name: 'Gunthorp Chicken',
                price: 21.99,
              },
              {
                name: 'Garlic Fries',
                price: 15.99,
              },
            ],
            dinner: [
              {
                name: 'Herring in Lavender Dill Reduction',
                price: 45.99,
              },
              {
                name: 'Truffle Noodles',
                price: 14.99,
              },
              {
                name: 'Charred Octopus',
                price: 25.99,
              },
            ],
          },
          address: {
            street: '2451 W Washburne Ave',
            city: 'Green Bay',
            state: 'WI',
            zip: '53295',
          },
          _id: 'Ar0qBJHxM3ecOhcr',
        },
      ],
      isPending: false,
    };
    expect(restaurantOutput).toEqual(expectedRestaurants);
  }));

  it('should show a loading div while isPending is true', () =&gt; {
    fixture.detectChanges();
    const originalGetRestaurants = service.getRestaurants;
    service.getRestaurants = () =&gt; of(restaurantAPIResponse).pipe(delay(100));
    fixture.componentInstance.form.get('state')!.patchValue('CA');
    fixture.componentInstance.form.get('city')!.patchValue('Sacramento');
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const loadingDiv = compiled.querySelector('.loading');
    expect(loadingDiv).toBeTruthy();
    service.getRestaurants = originalGetRestaurants;
  });

  it('should not show a loading div if isPending is false', () =&gt; {
    fixture.detectChanges();
    fixture.componentInstance.form.get('state')!.patchValue('CA');
    fixture.componentInstance.form.get('city')!.patchValue('Sacramento');
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const loadingDiv = compiled.querySelector('.loading');
    expect(loadingDiv).toBe(null);
  });

  it('should have a form property with city and state keys', () =&gt; {
    fixture.detectChanges();
    expect(fixture.componentInstance.form.controls['state']).toBeTruthy();
    expect(fixture.componentInstance.form.controls['city']).toBeTruthy();
  });

  it('should show a state dropdown', () =&gt; {
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const stateSelect = compiled.querySelector(
      'select[formcontrolname=&quot;state&quot;]'
    );
    expect(stateSelect).toBeTruthy();
  });

  it('should show a city dropdown', () =&gt; {
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const citySelect = compiled.querySelector('select[formcontrolname=&quot;city&quot;]');
    expect(citySelect).toBeTruthy();
  });

  it('should set states value to states response data and set isPending to false', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick();

    let stateOutput!: Data&lt;State&gt;;

    fixture.componentInstance.states$.subscribe(
      (states) =&gt; (stateOutput = states)
    );
    fixture.detectChanges();
    const expectedStates = {
      value: [
        { short: 'MO', name: 'Missouri' },
        { short: 'CA  ', name: 'California' },
        { short: 'MI', name: 'Michigan' },
      ],
      isPending: false,
    };
    expect(stateOutput).toEqual(expectedStates);
  }));

  it('should set state dropdown options to be values of states member', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick();
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const stateOption = compiled.querySelector(
      'select[formcontrolname=&quot;state&quot;] option:nth-child(2)'
    ) as HTMLInputElement;
    expect(stateOption.textContent?.trim()).toEqual('Missouri');
    expect(stateOption.value).toEqual('MO');
  }));

  it('should set cities value to cities response data and set isPending to false', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick();

    let cityOutput!: Data&lt;City&gt;;

    fixture.componentInstance.cities$.subscribe(
      (cities) =&gt; (cityOutput = cities)
    );
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.detectChanges();
    const expectedCities = {
      value: [
        { name: 'Sacramento', state: 'CA' },
        { name: 'Oakland', state: 'CA' },
      ],
      isPending: false,
    };
    expect(cityOutput).toEqual(expectedCities);
  }));

  it('should set city dropdown options to be values of cities member when state value is selected', fakeAsync((): void =&gt; {
    fixture.detectChanges();
    tick();
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.detectChanges();
    const compiled = fixture.nativeElement as HTMLElement;
    const cityOption = compiled.querySelector(
      'select[formcontrolname=&quot;city&quot;] option:nth-child(2)'
    ) as HTMLInputElement;
    expect(cityOption.textContent?.trim()).toEqual('Sacramento');
    expect(cityOption.value).toEqual('Sacramento');
  }));

  it('state dropdown should be disabled until states are populated', () =&gt; {
    const stateFormControl = fixture.componentInstance.form.get('state')!;
    expect(stateFormControl.enabled).toBe(false);

    fixture.detectChanges();

    expect(stateFormControl.enabled).toBe(true);
  });

  it('city dropdown should be disabled until cities are populated', fakeAsync((): void =&gt; {
    fixture.detectChanges(); // detecting changes for createForm func to be called
    const cityFormControl1 = fixture.componentInstance.form.get('city');
    expect(cityFormControl1?.enabled).toBe(false);
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.detectChanges();
    const cityFormControl2 = fixture.componentInstance.form.get('city');
    expect(cityFormControl2?.enabled).toBe(true);
  }));

  it('should reset list of restaurants when new state is selected', fakeAsync((): void =&gt; {
    fixture.detectChanges(); // detecting changes for createForm func to be called

    let restaurantOutput!: Data&lt;Restaurant&gt;;
    fixture.componentInstance.restaurants$.subscribe((restaurants) =&gt; {
      restaurantOutput = restaurants;
    });
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.componentInstance.form.get('city')?.patchValue('Sacramento');
    fixture.detectChanges();
    expect(restaurantOutput.value.length).toEqual(2);
    fixture.componentInstance.form.get('state')?.patchValue('MO');
    fixture.detectChanges();
    expect(restaurantOutput.value.length).toEqual(0);
  }));

  it('should call getRestaurants method with two string params', fakeAsync((): void =&gt; {
    const getRestaurantsSpy = spyOn(service, 'getRestaurants').and.returnValue(
      of(restaurantAPIResponse)
    );
    fixture.detectChanges();
    fixture.componentInstance.form.get('state')?.patchValue('CA');
    fixture.componentInstance.form.get('city')?.patchValue('Sacramento');
    fixture.detectChanges();
    tick();
    expect(getRestaurantsSpy).toHaveBeenCalledWith('CA', 'Sacramento');
  }));
});

</code></pre>
<div line-highlight='9, 11-13, 198-203, 306, 311-314, 319, 324-325, 357-362, 372, 390-395, 405, 421-427, 442-446, 450, 453, only'></div>
<p>If you’ve implemented the solution correctly, the tests will pass when you run <code>npm run test</code>!</p>
<h2>What you need to know</h2>
<ul>
<li><p>Creating streams of Form Control values with <code>valueChanges</code> member (you previously learned this in the <a href="form-value-changes.html#listening-to-form-changes" title="Learn how to listen to form value changes with Angular.">Filter Cities by State</a> section! ✔️)</p></li>
<li><p>How to perform common RxJS operations like:</p>
<ul>
<li><p>setting the initial value to be emitted</p></li>
<li><p>transforming a value emitted</p></li>
<li><p>combine previous and current values of a stream as an array</p></li>
<li><p>conditionally emit values into a stream from another stream</p></li>
<li><p>merge streams into a stream of arrays with values from each input stream</p></li>
<li><p>multicasting emissions of a &quot;cold&quot; observable and handle late subscribers</p>
<p>You’ve learnt all of the above as part of the earlier sections on this page! Completing the
<a href="../learn-rxjs.html">Bitovi Academy’s RxJS training</a> will help however.</p></li>
</ul></li>
</ul>
<h2>Solution</h2>
<p><details>
<summary>Click to see the solution</summary>
✏️ Update <strong>src/app/restaurant/restaurant.component.ts</strong></p>
<pre><code class="language-ts">import { Component, OnDestroy, OnInit } from '@angular/core';
import { FormBuilder, FormControl, FormGroup } from '@angular/forms';
import {
  combineLatest,
  map,
  mergeMap,
  Observable,
  of,
  pairwise,
  shareReplay,
  startWith,
  Subject,
  takeUntil,
  tap,
} from 'rxjs';
import { Restaurant } from './restaurant';
import {
  City,
  ResponseData,
  RestaurantService,
  State,
} from './restaurant.service';

export interface Data&lt;T&gt; {
  value: T[];
  isPending: boolean;
}

const toData = map(
  &lt;T&gt;(response: ResponseData&lt;T&gt;): Data&lt;T&gt; =&gt; ({
    value: response.data,
    isPending: false,
  })
);

@Component({
  selector: 'pmo-restaurant',
  templateUrl: './restaurant.component.html',
  styleUrl: './restaurant.component.css',
})
export class RestaurantComponent implements OnInit, OnDestroy {
  form: FormGroup&lt;{
    state: FormControl&lt;string&gt;;
    city: FormControl&lt;string&gt;;
  }&gt; = this.createForm();

  states$: Observable&lt;Data&lt;State&gt;&gt;;
  cities$: Observable&lt;Data&lt;City&gt;&gt;;
  restaurants$: Observable&lt;Data&lt;Restaurant&gt;&gt;;
  selectedState$: Observable&lt;string&gt;;
  selectedCity$: Observable&lt;string&gt;;
  enableStateSelect$: Observable&lt;Data&lt;State&gt;&gt;;
  toggleCitySelect$: Observable&lt;Data&lt;City&gt;&gt;;
  clearCityWhenStateChanges$: Observable&lt;[string, string]&gt;;

  private onDestroy$ = new Subject&lt;void&gt;();

  constructor(
    private restaurantService: RestaurantService,
    private fb: FormBuilder
  ) {
    this.selectedState$ = this.form.controls.state.valueChanges.pipe(
      startWith('')
    );

    this.selectedCity$ = this.form.controls.city.valueChanges.pipe(
      startWith('')
    );

    this.states$ = this.restaurantService
      .getStates()
      .pipe(
        toData,
        startWith({ isPending: true, value: [] }),
        shareReplay({ bufferSize: 1, refCount: true })
      );

    this.enableStateSelect$ = this.states$.pipe(
      takeUntil(this.onDestroy$),
      tap((states) =&gt; {
        if (states.value.length &gt; 0) {
          this.form.controls.state.enable();
        }
      })
    );

    this.cities$ = this.selectedState$.pipe(
      mergeMap((state) =&gt; {
        if (state) {
          return this.restaurantService
            .getCities(state)
            .pipe(toData, startWith({ isPending: true, value: [] }));
        } else {
          return of({ isPending: false, value: [] });
        }
      }),
      shareReplay({ bufferSize: 1, refCount: true })
    );

    this.toggleCitySelect$ = this.cities$.pipe(
      takeUntil(this.onDestroy$),
      tap((cities) =&gt; {
        if (cities.value.length === 0) {
          this.form.controls.city.disable({
            onlySelf: true,
            emitEvent: false,
          });
        } else {
          this.form.controls.city.enable({
            onlySelf: true,
            emitEvent: false,
          });
        }
      })
    );

    this.clearCityWhenStateChanges$ = this.selectedState$.pipe(
      takeUntil(this.onDestroy$),
      pairwise(),
      tap(([previous, current]) =&gt; {
        if (current &amp;&amp; current !== previous) {
          this.form.controls.city.setValue('');
        }
      })
    );

    this.restaurants$ = combineLatest([
      this.selectedCity$,
      this.selectedState$,
    ]).pipe(
      mergeMap(([city, state]) =&gt; {
        if (city &amp;&amp; state) {
          return this.restaurantService
            .getRestaurants(state, city)
            .pipe(toData, startWith({ isPending: true, value: [] }));
        } else {
          return of({ isPending: false, value: [] });
        }
      })
    );
  }

  ngOnInit(): void {
    this.enableStateSelect$.subscribe();
    this.toggleCitySelect$.subscribe();
    this.clearCityWhenStateChanges$.subscribe();
  }

  ngOnDestroy(): void {
    this.onDestroy$.next();
    this.onDestroy$.complete();
  }

  createForm(): FormGroup&lt;{
    state: FormControl&lt;string&gt;;
    city: FormControl&lt;string&gt;;
  }&gt; {
    return this.fb.nonNullable.group({
      state: { value: '', disabled: true },
      city: { value: '', disabled: true },
    });
  }
}

</code></pre>
<div line-highlight='3-15, 29-34, 47-54, 62-140, 144-146'></div>
<p>✏️ Update <strong>src/app/restaurant/restaurant.component.html</strong></p>
<pre><code class="language-html">&lt;div class=&quot;restaurants&quot;&gt;
  &lt;h2 class=&quot;page-header&quot;&gt;Restaurants&lt;/h2&gt;
  &lt;form class=&quot;form&quot; [formGroup]=&quot;form&quot;&gt;
    &lt;div class=&quot;form-group&quot;&gt;
      &lt;label&gt;State&lt;/label&gt;
      &lt;select
        *ngIf=&quot;states$ | async as states&quot;
        class=&quot;formControl&quot;
        formControlName=&quot;state&quot;
      &gt;
        &lt;option value=&quot;&quot; *ngIf=&quot;states.isPending&quot;&gt;Loading...&lt;/option&gt;
        &lt;ng-container *ngIf=&quot;!states.isPending&quot;&gt;
          &lt;option value=&quot;&quot;&gt;Choose a state&lt;/option&gt;
          &lt;option *ngFor=&quot;let state of states.value&quot; [value]=&quot;state.short&quot;&gt;
            {{ state.name }}
          &lt;/option&gt;
        &lt;/ng-container&gt;
      &lt;/select&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;
      &lt;label&gt;City&lt;/label&gt;
      &lt;select
        *ngIf=&quot;cities$ | async as cities&quot;
        class=&quot;formControl&quot;
        formControlName=&quot;city&quot;
      &gt;
        &lt;option value=&quot;&quot; *ngIf=&quot;cities.isPending&quot;&gt;Loading...&lt;/option&gt;
        &lt;ng-container *ngIf=&quot;!cities.isPending&quot;&gt;
          &lt;option value=&quot;&quot;&gt;Choose a city&lt;/option&gt;
          &lt;option *ngFor=&quot;let city of cities.value&quot; [value]=&quot;city.name&quot;&gt;
            {{ city.name }}
          &lt;/option&gt;
        &lt;/ng-container&gt;
      &lt;/select&gt;
    &lt;/div&gt;
  &lt;/form&gt;
  &lt;ng-container *ngIf=&quot;restaurants$ | async as restaurants&quot;&gt;
    &lt;div class=&quot;restaurant loading&quot; *ngIf=&quot;restaurants.isPending&quot;&gt;&lt;/div&gt;
    &lt;ng-container *ngIf=&quot;restaurants.value.length&quot;&gt;
      &lt;div class=&quot;restaurant&quot; *ngFor=&quot;let restaurant of restaurants.value&quot;&gt;
        &lt;img
          alt=&quot;&quot;
          src=&quot;{{ restaurant.images.thumbnail | imageUrl }}&quot;
          width=&quot;100&quot;
          height=&quot;100&quot;
        /&gt;
        &lt;h3&gt;{{ restaurant.name }}&lt;/h3&gt;

        &lt;div class=&quot;address&quot; *ngIf=&quot;restaurant.address&quot;&gt;
          {{ restaurant.address.street }}&lt;br /&gt;{{ restaurant.address.city }},
          {{ restaurant.address.state }} {{ restaurant.address.zip }}
        &lt;/div&gt;

        &lt;div class=&quot;hours-price&quot;&gt;
          $$$&lt;br /&gt;
          Hours: M-F 10am-11pm
          &lt;span class=&quot;open-now&quot;&gt;Open Now&lt;/span&gt;
        &lt;/div&gt;

        &lt;a class=&quot;btn&quot; [routerLink]=&quot;['/restaurants', restaurant.slug]&quot;&gt;
          Details
        &lt;/a&gt;
        &lt;br /&gt;
      &lt;/div&gt;
    &lt;/ng-container&gt;
  &lt;/ng-container&gt;
&lt;/div&gt;

</code></pre>
<div line-highlight='6-10, 22-26, 37, 64'></div>
<p></details></p>

</section>

  			
  			<bit-prev-next class="footer" list-selector=".sidebar-left ul li.parent.expanded ul"></bit-prev-next>
  		
    </div>

    
      <div class="sidebar-right">
        <div class="content-nav on-this-page-container">
          <h6>On this page...</h6>
          <div class="list-items" id="scroll-toc">
            <bit-toc heading-container-selector="article.main" scroll-selector="#scroll-toc"></bit-toc>
          </div>
        </div>
        <div class="pullout discord">
          <h6>Get help</h6>
          <p>If you need <a href="https://discord.gg/J7ejFsZnJ4">help</a> with an exercise, please reach out to us on
             <a href="https://discord.gg/J7ejFsZnJ4">Discord</a></p>
        </div>
        <div class="pullout bug">
          <p>If you find a bug, please
             <a href="https://github.com/bitovi/academy/issues/new">create an issue</a> or email
             <a href="mailto:contact@bitovi.com?Subject=Training%20Suggestion" target="_blank">contact@bitovi.com</a></p>
        </div>
      </div>
    

	</article>
</div>



  <footer></footer>

  <div id="scripts">
    <script type="text/javascript">
      var docObject = {"src":{"path":"src/angular/11-declarative-state/declarative-state.md"},"description":"Modify Restaurants component to derive state via RxJS streams \n","name":"learn-angular/declarative-state","title":"Optional: Declarative State","type":"page","parent":"learn-angular","order":11,"comment":" ","codepen":[["\"can\"","\"//unpkg.com/can@5/core.mjs\""],["\"can/everything\"","\"//unpkg.com/can@5/everything.mjs\""]],"pathToRoot":"../.."};
    </script>

    
      <script>
        steal = {
          instantiated: {
            "bundles/bit-docs-site/static.css!$css" : null
          }
        }
      </script>
      <script type='text/javascript'
          data-main="bit-docs-site/static"
          src="../static/steal.production.js"></script>
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2302003-12"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-2302003-12');
    </script>

  </div>
  <div id="email-modal" role="dialog" aria-modal="true" aria-labelledby="dialog_label" style="display: none;">
    <div aria-hidden="true" class="email-modal-backdrop"></div>
    <div role="region" class="email-modal-content">
      <h2 id="dialog_label">Join the Bitovi Newsletter</h2>
      <p>
        Do you want to receive updates about new Bitovi Academy courses, Bitovi open source projects, and dev community news? If so, please provide your email. We won’t spam you or give it away for any reason!<br />
        <i style="font-size: 0.8rem;">By providing your email you agree to receive communications from Bitovi</i>
      </p>
      <div id="academy-hubspot-form-embed"></div>
      <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/embed/v2.js"></script>
      <button id="email-modal-close" title="dismiss"><img src="../static/img/close.svg" height="24" width="24"></button>
    </div>
  </div>
</body>
</html>
