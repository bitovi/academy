import html2canvas from "./html2canvas";
import {detect} from "detect-browser";



// ## Basic Helpers
export function getIndex(data, x, y) {
	return (y * data.width * 4) + x * 4;
}
export function getXYChoord(data, index) {
	return [
		index % (data.width * 4),
		Math.floor(index / (data.width * 4))

	]
}
export function ave(num1, num2) {
	return Math.floor((num1+num2) / 2 )
}
export function getPixel(data, x, y) {
	var index = getIndex(data, x, y);
	return data.data.slice(index, index+4)
}
export function pixelEqual(p1, p2) {
	return p1[0] === p2[0] && p1[1] === p2[1] && p1[2] === p2[2] && p1[3] === p2[3];
}

// ## Canvas  utils

var tempCanvas = document.createElement("canvas");
var tempCtx = tempCanvas.getContext("2d");
export function resizeCanvas(canvas, scale) {
	var cw = tempCanvas.width = canvas.width;
	var ch = tempCanvas.height = canvas.height;


	tempCtx.drawImage(canvas,0,0);

	canvas.width *= scale;
	canvas.height *= scale;
	canvas.style.width = "";
	canvas.style.height = "";
	var ctx=canvas.getContext('2d');
	ctx.drawImage(tempCanvas,0,0,cw,ch,0,0, cw*scale,ch*scale );
}

export function copyToWidth(canvas, newWidth) {
	var newHeight = canvas.height * ( newWidth / canvas.width );
	var newCanvas = document.createElement("canvas");
	newCanvas.width = newWidth;
	newCanvas.height = newHeight;
	var newCtx = newCanvas.getContext("2d");

	newCtx.drawImage(canvas,0,0,canvas.width,canvas.height,0,0, newWidth,newHeight );
	return newCanvas;
}

function getImageData(image) {
	if(image.getContext) {
		var ctx = image.getContext('2d');
		return ctx.getImageData(0,0, image.width, image.height);
	} else {
		return image;
	}
}


// ## Image or Canvas comparisons

export function dataEqual(data1, data2) {
	var len = data1.data.length;
	for(var i = 0 ; i < len; i++) {
		if(data1.data[i] !== data2.data[i]) {
			console.log("difference at ",getXYChoord(data1, i));
			return false;
		}
	}
	return true;
}



export function diff(newImage, oldImage) {
	newImage = getImageData(newImage);
	oldImage = getImageData(oldImage);

	// find the minimal dimension
	var canvas = document.createElement("canvas");

	var maxWidth = Math.max(newImage.width, oldImage.width),
		minWidth = Math.min(newImage.width, oldImage.width),
		minHeight = Math.min(newImage.height, oldImage.height),
		maxHeight = Math.max(newImage.height, oldImage.height);

	canvas.width = maxWidth;
	canvas.height = maxHeight;
	var ctx = canvas.getContext('2d');
	var diffOut = ctx.createImageData(maxWidth, maxHeight);
	var equal = true;

	for(var y = 0; y < maxHeight; y++) {
		for(var x = 0; x < maxWidth; x++) {

			var newPixel = getPixel(newImage, x, y);
			var oldPixel = getPixel(oldImage, x, y);
			var index = getIndex(diffOut, x, y);

			if( !pixelEqual(newPixel, oldPixel) ) {
				equal = false;
				// average numbers and max out red ...
				diffOut.data[index] = 255;
				diffOut.data[index+1] = ave(newPixel[1] , oldPixel[1]);
				diffOut.data[index+2] = ave(newPixel[2] , oldPixel[2]);
				diffOut.data[index+3] = 255;
			} else {
				diffOut.data[index] = newPixel[0];
				diffOut.data[index+1] = newPixel[1];
				diffOut.data[index+2] = newPixel[2];
				diffOut.data[index+3] = newPixel[3];
			}
		}
	}
	if(equal) {
		return
	} else {
		ctx.putImageData(diffOut, 0, 0);
		return canvas;
	}
}

var firstUrl = "data:image/octet-stream;base64,iVBORw0KGgoAAAANSUhEUgAAA+gAAAGQCAYAAAA9TUphAAAgAElEQVR4Xu3dB5RdZbUH8A1KFQERFJCmWOgISK8iHULvJQFCgFBDSehFIRCK9NB7J/TeQZoI0lSq+gABEaQIoiBFeGsfuOPMJFOCvszn+35nrbfWk7kzd5/f3vfk/E+7433yySefhIUAAQIECBAgQIAAAQIECBDoU4HxBPQ+9ffmBAgQIECAAAECBAgQIECgERDQDQIBAgQIECBAgAABAgQIEChAQEAvoAlKIECAAAECBAgQIECAAAECAroZIECAAAECBAgQIECAAAECBQgI6AU0QQkECBAgQIAAAQIECBAgQEBANwMECBAgQIAAAQIECBAgQKAAAQG9gCYogQABAgQIECBAgAABAgQICOhmgAABAgQIECBAgAABAgQIFCAgoBfQBCUQIECAAAECBAgQIECAAAEB3QwQIECAAAECBAgQIECAAIECBAT0ApqgBAIECBAgQIAAAQIECBAgIKCbAQIECBAgQIAAAQIECBAgUICAgF5AE5RAgAABAgQIECBAgAABAgQEdDNAgAABAgQIECBAgAABAgQKEBDQC2iCEggQIECAAAECBAgQIECAgIBuBggQIECAAAECBAgQIECAQAECAnoBTVACAQIECBAgQIAAAQIECBAQ0M0AAQIECBAgQIAAAQIECBAoQEBAL6AJSiBAgAABAgQIECBAgAABAgK6GSBAgAABAgQIECBAgAABAgUICOgFNEEJBAgQIECAAAECBAgQIEBAQDcDBAgQIECAAAECBAgQIECgAAEBvYAmKIEAAQIECBAgQIAAAQIECAjoZoAAAQIECBAgQIAAAQIECBQgIKAX0AQlECBAgAABAgQIECBAgAABAd0MECBAgAABAgQIECBAgACBAgQE9AKaoAQCBAgQIECAAAECBAgQICCgmwECBAgQIECAAAECBAgQIFCAgIBeQBOUQIAAAQIECBAgQIAAAQIEBHQzQIAAAQIECBAgQIAAAQIEChAQ0AtoghIIECBAgAABAgQIECBAgICAbgYIECBAgAABAgQIECBAgEABAgJ6AU1QAgECBAgQIECAAAECBAgQENDNAAECBAgQIECAAAECBAgQKEBAQC+gCUogQIAAAQIECBAgQIAAAQICuhkgQIAAAQIECBAgQIAAAQIFCAjoBTRBCQQIECBAgAABAgQIECBAQEA3AwQIECBAgAABAgQIECBAoAABAb2AJiiBAAECBAgQIECAAAECBAgI6GaAAAECBAgQIECAAAECBAgUICCgF9AEJRAgQIAAAQIECBAgQIAAAQHdDBAgQIAAAQIECBAgQIAAgQIEBPQCmqAEAgQIECBAgAABAgQIECAgoJsBAgQIECBAgAABAgQIECBQgICAXkATlECAAAECBAgQIECAAAECBAR0M0CAAAECBAgQIECAAAECBAoQENALaIISCBAgQIAAAQIECBAgQICAgG4GCBAgQIAAAQIECBAgQIBAAQICegFNUAIBAgQIECBAgAABAgQIEBDQzQABAgQIECBAgAABAgQIEChAQEAvoAlKIECAAAECBAgQIECAAAECAroZIECAAAECBAgQIECAAAECBQgI6AU0QQkECBAgQIAAAQIECBAgQEBANwMExrHAX/7yVlx65ZXx6p9fi2/OPFOstcbq8aVJJ40rrr42nn3uuQ7VfH+euWO5ZX8Yt9/5s3j0V7+O8cYbLyaffPKYc/bZYtGFF2r+9znnXxgLL/iDmO173+3wu6+++ue45PIrYodtt44HH3o4/vzaa7H6qqu0veadv/0tbrzl1nj22edi4oknjnnnniuWWWrJ5m8ed+JJ8cEHH3b4e/1WWTm+993vRFf1j2PG0d7u4UcejV8+8mi89vrrMdOMM8RKyy8XX//a1+JTh8tjp+0Gj/Y7Rx13QvTfZKOY+qtfjYceeSR+dve9HV7z1a9OFVtstmnzszf/8las8KNlO/z85794ID755JOYZpqp45rrbhgjwQrLLRvzzDVX87NzLrgw5p177si+tpbHn3wy/ufZ52KN1VZt+29vvf12nHXu+U3vJphggvjnP/8Zt9x2ezz1zG+b//+73/l2rLzC8jHhhBM2v/Pue+/Fiaec1vz/E044QbPeOTdfnWqq5r8987vfxS8e/GUM2GTjtvd48aWX4urrro8tB/SPSSeZpE/b99zzz8dd99wXL/7xjzH9tNPG4osu0mGeL7h4VMw37zwxx+yztdX597//PU467YzYabttG4ezz7sgXn/jjfjCF8aPqaaaKhZbeOH4zrdn7bBerdd0XtnJJpsstt1qy24/g63fuenW2+L111+PTTfasMOfyc/v5F+erHHvvGR/Tj3jrFhv7TXjG9NP36fWPc1SFtdyGn/88SM/A4ssuGDz2c+lu+3Ulddc2/Rt9u99r8M6XnLZ5c32aqYZZ+zw3++6597Iz9DEE08USy2xRCww3/fbfv7223+Nm269Nf7nuedi8i9/ufncLLn4Ym0/v/ve++K99/4RKy7/ow5/88xzzoull1wiZv3WN7vdbrZ+6Q8vvBg/u+eeeOHFl+Jr00wdSyy6aMw5x+zNj7vbDvZVE1s15XZ6iikmb7YlP5h//qac7rZ1vel7/o38d+GmW26LZ59/rvk34Hvf+XassuKKMdlkX+qrVW573+56lS/qaWb+U9vxrrYBWUNXNfa07WmtZG/m+sOPPor8rD3z29/FNF/9aqy2ykoxwze+0ef9eeutt+LQww6PLQYMiNlm67gNyOLuufe+uOeee+LlP70S3/72rLHeuuuMtj087IgjY64554xVV1m5bX1e+uMf4/gTRrb972mmnjrmmmuuWGH55SK3Ubl0fk3rxfvus3e8/fbbcdLJp8Sw3XeLKaaYYjSn666/If70pz/FoK0GNq+bY445Yumllmx73ccffxxZ12qrrhJzf/ZveZ9jK+D/vYCA/v++xVawJIEPP/wwBgzaNpZaYvGYa47Z46FHHo0vTzZZDNy8f+y53wEx6aSTxuKLLNxWcu7M5w7v0cePjFdefTVWXWnFeO75PzTBeonFFokdtt0mzjz3vPjd7/8nDv3JgR1WdeQppzVB4oB99mqCYYbAn+y3T/Oa/Id9z/0PiHnmnDMWXmjBJmTm31xkoQVj0w03iBVXXys23mC9mKFdmJhrzjliqq98pcv6+9L58KOOiZ8/8GCsu+bqMf300zfrmoH2nNNPiRdffCl22m1o3HztVaOV+MOVVo0zTx4Z35xllrj40svj1tvvaNa7tWQ/Mljkz04548w4+vARHcL1Weed3wTm1VZeKR597FfNr9159z1NYF51xRWa/507GzPO8OnOU+5c54GZ4Qfu3/Ye+xz4k3j40cfi6lEXx0QTfRq4r73hxub/Tj3huPjrO+/EbnvuHRNNOGET/r7whS80BxLygMtPRwyPr00zTWSgX2O9DWPvobvHx598HL98+JEmkJ918onx9a9/LX529z3NDJx1yknN38/Xb7vjkNiy/6axwnIdA8647uN1N9wUJ556WqzRb9WmD7mjdflVV8cmG2zQ1ottdtw51l599Q5hLMP4OhttGjdcdXlzgGvAoG1i0YUXbg5ePPnUU3HdjTfHPnsMjSUXW7Rtle75+f3xt3feidzB/emxx8fgQVvFFJN/OSaaeOJYdumluv0M5h/J31tv482anp924vEx7de/3va38/ObB9EuPPuMtgMjrR9maEz/4486ou1gzbh2zvfrzSzl61qWs333O/Hrxx+Pm2+7PXbefrvmAFV326n8WW6LTj/phPjKlFO2reLOuw+L/htvFAvMP1/bf7v+ppubz9UW/TeNf/zjH3HVNdfFkSOGN2H8qWeeib32/3EsOP98Mf9834933nknrrn+hibgH3zAfs1O+cmnnRFv//Wvscduu3Sg3GSLrWK7rbdqDvJ0t93MX8oajj/plOi38krNAYg333orrrjqmmZu5p5zji63g3kArK+W3DZvvunGMf1008Wzzz8fV197ffM5WX+dtZvt+pi2db3t+5NPPxN7H/Dj5mDtQj9YoNnW3P/Ag81BzxOPOaqvVrl535561ZuZ+U9sx7vbBnRXY25zu9v2tHB7M9fDDzsi/vb3v8cqK60YL730UrPdOXz4QX3an3zz004/I4457vhYacUV4qdHHN6hnqHD9ozbbr89ttxi85h55pnjqaefjsuvuCLuuO3WmOxLnx78efyJJ2KDjTaJKaecMu69687mZEEuv/71b2KNtdeJY476afO/33jjjbju+uvjo4/+GWefeUZMNdVX2l5z9FFHdnjflVdcMZ555rexSr/VY+tBW8X++366D9Ra8qDCYksu3QTvSy66IG6/444Ytufecc/P7mj2x3IZdellcfIpp8YtN90QX/ziF/vcWQF1CAjodfTZWhYikDtAB484LC48+8zRKsqd29wx2mj9fwXE1otyRzPPDLbOAucZ9WNPPCmuufSSZudpo/5bxEXnnhV5ZDmX3IlYZ6NN4if77hPfn3eeDgE9w/jWO+wUP5h/vthm4JZtdXz8ySfx0YcfNmcjcyfwmCNGjHYmrLv6+4r43p/fH4f99OgmfE499VfbyvjH++/HxBNN1OVOa76wc0B/5LHHxrijkzt2ecbigw8/iDNOHNnsEOTSCuhbbT6g7X1zByt3xvbcfdfRSB557Fex1/4HxnWXj2rOjP/93XdjvU36x/TTTdsEmDxwk0u+Zo7ZZovNNt4wTjj5lOagTO6A5Q5zLtnDHx8yIr74hS/EvnsOawvo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AQLFCAjoxbRCIQQIECBAgAABAgQIECBQs4CAXnP3rTsBAgQIECBAgAABAgQIFCMgoBfTCoUQIECAAAECBAgQIECAQM0CAnrN3bfuBAgQIECAAAECBAgQIFCMgIBeTCsUQoAAAQIECBAgQIAAAQI1CwjoNXffuhMgQIAAAQIECBAgQIBAMQICejGtUAgBAgQIECBAgAABAgQI1CwgoNfcfetOgAABAgQIECBAgAABAsUICOjFtEIhBAgQIECAAAECBAgQIFCzgIBec/etOwECBAgQIECAAAECBAgUIyCgF9MKhRAgQIAAAQIECBAgQIBAzQICes3dt+4ECBAgQIAAAQIECBAgUIyAgF5MKxRCgAABAgQIECBAgAABAjULCOg1d9+6EyBAgAABAgQIECBAgEAxAgJ6Ma1QCAECBAgQIECAAAECBAjULCCg19x9606AAAECBAgQIECAAAECxQgI6MW0QiEECBAgQIAAAQIECBAgULOAgF5z9607AQIECBAgQIAAAQIECBQjIKAX0wqFECBAgAABAgQIECBAgEDNAgJ6zd237gQIECBAgAABAgQIECBQjICAXkwrFEKAAAECBAgQIECAAAECNQsI6DV337oTIECAAAECBAgQIECAQDECAnoxrVAIAQIECBAgQIAAAQIECNQsIKDX3H3rToAAAQIECBAgQIAAAQLFCAjoxbRCIQQIECBAgAABAgQIECBQs4CAXnP3rTsBAgQIECBAgAABAgQIFCMgoBfTCoUQIECAAAECBAgQIECAQM0CAnrN3bfuBAgQIECAAAECBAgQIFCMgIBeTCsUQoAAAQIECBAgQIAAAQI1CwjoNXffuhMgQIAAAQIECBAgQIBAMQICejGtUAgBAgQIECBAgAABAgQI1CwgoNfcfetOgAABAgQIECBAgAABAsUICOjFtEIhBAgQIECAAAECBAgQIFCzgIBec/etOwECBAgQIECAAAECBAgUIyCgF9MKhRAgQIAAAQIECBAgQIBAzQICes3dt+4ECBAgQIAAAQIECBAgUIyAgF5MKxRCgAABAgQIECBAgAABAjULCOg1d9+6EyBAgAABAgQIECBAgEAxAgJ6Ma1QCAECBAgQIECAAAECBAjULDDem2+++UnNANadAAECBAgQIECAAAECBAiUIOAMegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9gIBe/QgAIECAAAECBAgQIECAAIESBAT0ErqgBgIECBAgQIAAAQIECBCoXkBAr34EABAgQIAAAQIECBAgQIBACQICegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9gIBe/QgAIECAAAECBAgQIECAAIESBAT0ErqgBgIECBAgQIAAAQIECBCoXkBAr34EABAgQIAAAQIECBAgQIBACQICegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9gIBe/QgAIECAAAECBAgQIECAAIESBAT0ErqgBgIECBAgQIAAAQIECBCoXkBAr34EABAgQIAAAQIECBAgQIBACQICegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9gIBe/QgAIECAAAECBAgQIECAAIESBAT0ErqgBgIECBAgQIAAAQIECBCoXkBAr34EABAgQIAAAQIECBAgQIBACQICegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9gIBe/QgAIECAAAECBAgQIECAAIESBAT0ErqgBgIECBAgQIAAAQIECBCoXkBAr34EABAgQIAAAQIECBAgQIBACQICegldUAMBAgQIECBAgAABAgQIVC8goFc/AgAIECBAgAABAgQIECBAoAQBAb2ELqiBAAECBAgQIECAAAECBKoXENCrHwEABAgQIECAAAECBAgQIFCCgIBeQhfUQIAAAQIECBAgQIAAAQLVCwjo1Y8AAAIECBAgQIAAAQIECBAoQUBAL6ELaiBAgAABAgQIECBAgACB6gUE9OpHAAABAgQIECBAgAABAgQIlCAgoJfQBTUQIECAAAECBAgQIECAQPUCAnr1IwCAAAECBAgQIECAAAECBEoQENBL6IIaCBAgQIAAAQIECBAgQKB6AQG9+hEAQIAAAQIECBAgQIAAAQIlCAjoJXRBDQQIECBAgAABAgQIECBQvYCAXv0IACBAgAABAgQIECBAgACBEgQE9BK6oAYCBAgQIECAAAECBAgQqF5AQK9+BAAQIECAAAECBAgQIECAQAkCAnoJXVADAQIECBAgQIAAAQIECFQvIKBXPwIACBAgQIAAAQIECBAgQKAEAQG9hC6ogQABAgQIECBAgAABAgSqFxDQqx8BAAQIECBAgAABAgQIECBQgoCAXkIX1ECAAAECBAgQIECAAAEC1QsI6NWPAAACBAgQIECAAAECBAgQKEFAQC+hC2ogQIAAAQIECBAgQIAAgeoFBPTqRwAAAQIECBAgQIAAAQIECJQgIKCX0AU1ECBAgAABAgQIECBAgED1AgJ69SMAgAABAgQIECBAgAABAgRKEBDQS+iCGggQIECAAAECBAgQIECgegEBvfoRAECAAAECBAgQIECAAAECJQgI6CV0QQ0ECBAgQIAAAQIECBAgUL2AgF79CAAgQIAAAQIECBAgQIAAgRIEBPQSuqAGAgQIECBAgAABAgQIEKheQECvfgQAECBAgAABAgQIECBAgEAJAgJ6CV1QAwECBAgQIECAAAECBAhULyCgVz8CAAgQIECAAAECBAgQIECgBAEBvYQuqIEAAQIECBAgQIAAAQIEqhcQ0KsfAQAECBAgQIAAAQIECBAgUIKAgF5CF9RAgAABAgQIECBAgAABAtULCOjVjwAAAgQIECBAgAABAgQIEChBQEAvoQtqIECAAAECBAgQIECAAIHqBQT06kcAAAECBAgQIECAAAECBAiUICCgl9AFNRAgQIAAAQIECBAgQIBA9QICevUjAIAAAQIECBAgQIAAAQIEShAQ0EvoghoIECBAgAABAgQIECBAoHoBAb36EQBAgAABAgQIECBAgAABAiUICOgldEENBAgQIECAAAECBAgQIFC9wP8CCkr/aL5IuM8AAAAASUVORK5CYII=";

export function downloadLink(canvas, title, text) {
	var anchor = document.createElement("a");
	anchor.setAttribute("download", title);
	var url = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
	//console.log(url);
	anchor.setAttribute("href", url );
	anchor.textContent = text;
	return anchor;
}

function makeBoxForCanvas(canvas, title) {
	var div = document.createElement("div");
	div.style.display = "inline-block";
	div.style.border = "solid 1px black";
	var paragraph = document.createElement("p");
	paragraph.textContent = title;
	div.appendChild(paragraph)

	div.appendChild(canvas);
	return div;
}

function getWidth(){
	return Math.max(
		document.body.scrollWidth,
		document.documentElement.scrollWidth,
		document.body.offsetWidth,
		document.documentElement.offsetWidth,
		document.documentElement.clientWidth
	);
}

export function diffContent(diffCanvas, newCanvas, oldCanvas, imageName) {
	var width = Math.floor( getWidth() / 3 ) - 50;

	// get links
	var newCanvasDownload = downloadLink(newCanvas,imageName, "download new "+imageName);

	var diffSized = copyToWidth(diffCanvas, width);
	var newSized = copyToWidth(newCanvas, width);
	var oldSized = copyToWidth(oldCanvas, width);

	var diffContent = makeBoxForCanvas(diffSized, "Difference:");
	var newContent = makeBoxForCanvas(newSized, "Current Rendering:");
	newContent.querySelector("p").appendChild(newCanvasDownload);
	var oldContent = makeBoxForCanvas(oldSized, imageName);

	var div = document.createElement("div");
	div.appendChild(diffContent);
	div.appendChild(newContent);
	div.appendChild(oldContent);
	return div;
}

/**
{
	url: "../doc/training/style-guide.html",
	width: 1000,
	snapshotDir: "./",
	snapshotPrefix: "style-guide"
}
 */
export function compareToSnapshot(options) {

	var htmlPromise = getCanvasForUrl(options.url);
	return Promise.all([
		getCanvasForUrl(options.url),
		findImage(options)
	]).then(function(results){
		var iframeCanvas = results[0];
		var imageCanvas = results[1].canvas;
		var imageName = results[1].name;

		var diffCanvas = diff(iframeCanvas, imageCanvas);
		if(diffCanvas) {
			return Promise.reject({
				html: diffContent(diffCanvas, iframeCanvas, imageCanvas, imageName),
				imageName: imageName
			});
		} else {
			return {imageName: imageName}
		}
	}, function(err){
		return htmlPromise.then(function(iframeCanvas){

			/*var image = getImageData(iframeCanvas);
			var pixel = getPixel(image, 221, 54);
			var eq = pixelEqual(pixel, [238, 238, 239, 255]);*/

			var imageName = err.attempts[0];
			var newCanvasDownload = downloadLink(iframeCanvas,imageName, imageName);
			var p = document.createElement("p");
			p.textContent = "There is no snapshot. Download the snapshot by right-clicking ";
			p.appendChild(newCanvasDownload);
			p.append(" and select 'Save Link As...'.");
			return Promise.reject({
				attempts: err.attempts,
				html: p
			})
		})

	})
}


export function findImage(options){
	var browser = detect();

	var attempts = [
		options.snapshotPrefix+"-"+options.width+"-"+browser.name+".png",
		options.snapshotPrefix+"-"+options.width+".png",
		options.snapshotPrefix+".png"
	];

	var base = Promise.reject();

	attempts.forEach(function(name){
		base = base.catch(function(err){
			return getCanvasForImage(options.snapshotDir+name).then(function(canvas){
				return {canvas: canvas, name: name}
			})
		})
	});

	return base.catch(function(){
		return Promise.reject({
			attempts: attempts
		})
	});
}




// ## Helpers that get canvases
export function getCanvasForUrl(url) {
	return new Promise(function(resolve, reject){
		var div = document.createElement("div");
		div.style.position = "fixed";
		div.style.top = div.style.left = "-1000px"
		div.style.height = "400px";
		div.style.width = "1000px";
		document.body.appendChild(div);
		//var fixture = document.getElementById("qunit-fixture");

		var iframe = document.createElement("iframe");
		iframe.style.width = "100%";
		iframe.style.height = "100%";
		iframe.style.backgroundColor = "white";
		iframe.src = url;
		iframe.onload = function(){
			console.log("load");
			setTimeout(function(){
				html2canvas(iframe.contentWindow.document.body, {
					allowTaint: true,
					foreignObjectRendering: true,
					useCORS: true,
					windowWidth: 1000,
					width: 1000,
					devicePixelRatio: 1
				})
					.then(resolve, reject).then(function(){
						setTimeout(function(){
							document.body.removeChild(div);
						},13);

					});

			},13)

		}
		div.appendChild(iframe);
	})

}

export function getCanvasForImage(url) {
	return new Promise(function(resolve, reject){
		var image = new Image();

		image.onload = function(){
			var canvas = document.createElement("canvas");
		    //document.body.appendChild(canvas);

		    canvas.width  = image.width;
		    canvas.height = image.height;

		    var context = canvas.getContext("2d");

		    context.drawImage(image, 0, 0);
			resolve(canvas);
		}
		image.onerror = reject;

		image.src = url;


	});


}
